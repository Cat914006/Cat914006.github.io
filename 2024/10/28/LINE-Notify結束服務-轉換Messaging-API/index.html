<!DOCTYPE html><html lang="zh-TW"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>LINE Notify結束服務(轉換Messaging API) | 天下本無事 庸人自擾之</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">LINE Notify結束服務(轉換Messaging API)</h1><a id="logo" href="/.">天下本無事 庸人自擾之</a><p class="description">It's nothing to do with the world, but the mediocrity of the people!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 歸檔</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">LINE Notify結束服務(轉換Messaging API)</h1><div class="post-meta">2024-10-28</div><div class="post-content"><ul>
<li>緣起</li>
</ul>
<p>就….免錢的LINE Notify不給用!<br>也是很同意使用者付費這件事!但過程上還是煩人<br>就不能直接Notify收費嗎?╮(╯∀╰)╭<br>養．套．殺行雲流水~<br>Notify或Messaging不就是一個名詞?<br>好啦!以上只是無能+想偷懶的碎嘴!<br>想來Notify要轉換收費還真的可能是另一種嚇人。  </p>
<span id="more"></span>
<pre><code>  ※接下來的功課開發環境會是WebForm 混打PHP，是的非MVC..
    不過MVC感覺說不定反而很多地方可以抄(笑  
    所以只來抄作業的!又非WebForm自行左轉啊...( ͡° ͜ʖ ͡°)
    話說，全篇完後又覺得...這篇莫非是87% PHP?
</code></pre>
<ul>
<li><p>起手式<br><a target="_blank" rel="noopener" href="https://developers.line.biz/en/reference/messaging-api/">Messaging API文件</a><br>簡直是天書啊?笑~<br>通知信裡只有二個重點，給你價格，給你API文件???<br>這些確實重要，不過這個開始時間點，我事實上只想知道~<br>1.和Notify那裡不同?<br>2.是用什麼機制，可以從公司內部的編號直接傳訊息給某員工?<br>3.又是用什麼機制，傳訊息給一個公司群組?  </p>
</li>
<li><p>解鎖迷團</p>
</li>
</ul>
<ol>
<li>和Notify那裡不同?不知道是太笨還是..<br> 後來覺得這個問題，倒不如應該問<strong>那裡相同</strong>?笑<br> 總之Notify、Messaging先將二個當成完全不同的東西!<br> 無較無益，不會讓你開發比較快。╮(′～‵〞)╭ ~  </li>
<li>傳訊息給某員工?<br> 取得使用者的UserID搭配你的Channel Access Token<br> 就可以傳送訊息給某個人!<br> 大前提是對方要和你的Channel是好友。<br> 事實上也不難理解，就像A傳給B一樣也是先加好友!<br> UserID→通常是U開頭的字串<br> 這個UserID就是唯一身份，我之前曾經多想了!<br> 覺得ChannelA的使用者會拿到A專用的UserID<br> 切到ChannelB又會拿到另一組B專用UserID真的是腦洞開很大!<br> 並沒有 就是單純的唯一值，所以你只要取得一次UserID<br> 就算你有100個Channel，只要對方和你是好友，你就可以傳。<br> …就問?正常人誰會加100個Channel?╮(′～‵〞)╭</li>
<li>傳訊息給一個公司群組?<br> 取得GroupID搭配你的Channel Access Token<br> 就可以傳送訊息至某個群組!大前提是你的Channel有被邀請至群組之中<br> 理解為你的Channel就是一人頭，被邀請了才有說話的資格，只差在你的那個人頭，開口千金!???笑….<br> GroupID→通常是C開頭的字串<br> 在群組發送訊息等同Channel的<strong>群發訊息</strong><br> 你的群組多少人，發送則數×人頭<br> 200人的大群一則訊息就把免費發送額度清零!笑<br> 另一個要注意的地方是一個群組加入一個Channel<br> 好像就不能加入另一個了?我不知道付費的Channel是否有不同就是了!(煙<br> 至少就目前的測試起來是這樣子的!我本來還想說一個群多加幾個Channel<br> 然後…後端開發時，用條件控制用那個Channel發送訊息就好了!不怕額度不足!計畫通484!!<br> 結論：自以為…只有你想的到？ ╮(′～‵〞)╭ 笨小孩!</li>
</ol>
<ul>
<li><p>開發前的準備資料  </p>
<ol>
<li>Channel相關<br>  新建和設定Channel資料的基本上是0開發<br>  不管你是參考官網或寫的清楚100倍的其他網站，<br>  基本上是建立一個Channel找到以下資料備著：<br>  1.Channel ID<br>  2.Channel secret<br>  3.Channel Access Token<br>  這裡就不像老太太的某布一樣，寫的又臭又長了..  </li>
<li>UserID <a target="_blank" rel="noopener" href="https://developers.line.biz/en/docs/messaging-api/getting-user-ids/">官網UserID文件</a><br>  這就是一個很重要的值了，取得這個ID的方法多樣!<br>  好像某個付費等級的帳號可以直接查?笑 這個就真的沒看的太細<br>  總之平民們大約是二條路(就我查的資料來說…╮(╯∀╰)╭<br>  1.LINE Login(Callback URL)<br>  2.Messaging API(Webhook URL)<br>  我想之前有用時代的眼淚?的Notify的開發人員，<br>  應該和Callback URL很熟，是的，那時怎麼玩，接下來還是這玩滴<br>  當然LINE Login的功能強大，不只於此，拿來取UserID是有點大材小用了<br>  但只需小改程式就是爽!(雖然我後來也沒用到…)<br>  他的走法就是你用ChannelID+Secret去換一個可以取UserId的權杖<br>  中間有個state的值可以扔來扔去!就看個人的需求，我是拿來塞員工編號。<br>  如果你家的員編是身份證號什麼的???可能需要想想要怎麼變型或加密。<br>  和Notify中Callback URL有一個小小的不同!就是安全性增加了!要https才給吃!不要說這個沒什麼!<br>  我就卡這裡了，哈 公司沒任何IIS主機有https，問就是….<br>  總之 好在公司有NAS，所以以下的CallbacK和Webhook對應會是PHP!<br>  是的…PHP，為了用NAS內給的憑證，所以小抄中這一塊會是PHP ~<br>  我也不想啊! 我也不會寫PHP啊! 但我就是迷有HTTPS啊~<br>  只能說好在 那個GTP、Claude他們會寫PHP ~ 不怕不怕!( ͡° ͜ʖ ͡°)  </li>
<li>GroupID <a target="_blank" rel="noopener" href="https://developers.line.biz/en/reference/messaging-api/#join-event">官方GroupID</a><br>  這個網址，嗯 事實上有點不對題!!<br>  但真的是我我盡力在官方裡找出我勉強接邊又微微能懂的地方了 笑╮(╯∀╰)╭<br>  總之就是介紹你能用什麼”方法”得到GroupID的值。<br>  我是用當你的Channel被某個群組邀請進入後<br>  會回報Join event 這裡就用Webhook URL去接收，然後你就可以拿到GroupID了。<br>  這裡的event，只能說不愧是LINE，非常細且完整!<br>  有強迫症的你慢慢看吧!我沒有 我翻篇ING..往下<br>  <strong>※ Webhook URL Https 必需的</strong></li>
</ol>
</li>
<li><p>Channel 群組 傻傻分不清楚 笑<br>在小抄開始前 插一下這個讓我想了一下的地方<br>如果你無痛跨過，棒棒滴!反正我不是 笑<br>二個都是可以發訊給”一推人”但功能上有滿大的差異<br>1.想在某個群組發送訊息，要將Channel加入群組。<br>2.發送群組訊息和發送1對1訊息大同小異!(他們是同一個支線，收費上的差異而以!)<br>3.在Channel可以<strong>推送</strong>訊息給每個會員，但會員間並不知道(收費看Channel人數)<br>4.群組所有成員都可以看到和發送訊息非常透明當然也相對混亂，Channel會員只能連繫管理員。<br>5.Channel可以對會員進行管理，推送時也可以作更細部的設定。 </p>
</li>
<li><p>LINE Login 取得使用者的UserId<br><a target="_blank" rel="noopener" href="https://developers.line.biz/en/reference/line-login/">官方文件</a><br>簡單的流程大約是 用LINE Login的ChannelId當參數至Authorize網頁, 待使用者同意，同意後轉址。<br>再來，工作交給CallBack頁面，用ClientSecret去換權杖，如果沒問題，再權杖換取UserId.  </p>
</li>
<li><p>轉至LINE Login登入，同意使用頁面</p>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> clientId = <span class="string">&quot;xxxx&quot;</span>;</span><br><span class="line"> <span class="built_in">string</span> redirectUri = HttpUtility.UrlEncode(<span class="string">&quot;https://XXX/callback.php&quot;</span>);  <span class="comment">// CallBackURL 使用 URL 編碼</span></span><br><span class="line"> <span class="built_in">string</span> state = <span class="string">$&quot;<span class="subst">&#123;Guid.NewGuid()&#125;</span>&quot;</span>; <span class="comment">//自由輸入</span></span><br><span class="line"> state += <span class="string">$&quot;<span class="subst">&#123;UserId&#125;</span>&quot;</span> <span class="comment">//我將員編塞在這裡</span></span><br><span class="line"> </span><br><span class="line"> <span class="built_in">string</span> scope = HttpUtility.UrlEncode(<span class="string">&quot;profile openid&quot;</span>);</span><br><span class="line"> <span class="built_in">string</span> lineAuthUrl = <span class="string">$&quot;https://access.line.me/oauth2/v2.1/authorize?response_type=code&amp;client_id=<span class="subst">&#123;clientId&#125;</span>&amp;redirect_uri=<span class="subst">&#123;redirectUri&#125;</span>&amp;state=<span class="subst">&#123;state&#125;</span>&amp;scope=<span class="subst">&#123;scope&#125;</span>&quot;</span>;</span><br><span class="line"> Response.Redirect(lineAuthUrl);</span><br></pre></td></tr></table></figure>
</li>
<li><p>CallBack頁面(PHP)  </p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 開啟 PHP 錯誤報告</span></span><br><span class="line"> <span class="comment">//ini_set(&#x27;display_errors&#x27;, 1);</span></span><br><span class="line"> <span class="comment">//ini_set(&#x27;display_startup_errors&#x27;, 1);</span></span><br><span class="line"> <span class="comment">//error_reporting(E_ALL);</span></span><br><span class="line"> <span class="comment">// 設定 LINE Login 的參數</span></span><br><span class="line"> <span class="variable">$client_id</span> = <span class="string">&#x27;XXX&#x27;</span>;</span><br><span class="line"> <span class="variable">$client_secret</span> = <span class="string">&#x27;XXX&#x27;</span>;</span><br><span class="line"> <span class="variable">$redirect_uri</span> = <span class="string">&#x27;https://XXX/callback.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 取得授權碼</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;state&#x27;</span>])) &#123;</span><br><span class="line"> <span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"> <span class="variable">$state</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;state&#x27;</span>];</span><br><span class="line"> <span class="variable">$employee_code</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$state</span>, -<span class="number">5</span>); </span><br><span class="line"> <span class="comment">// 取得員編，這裡依需求塞入資料可能不同</span></span><br><span class="line"> <span class="comment">// 記得依需求改為你需要的</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 交換授權碼以取得存取權杖</span></span><br><span class="line"> <span class="variable">$token_url</span> = <span class="string">&#x27;https://api.line.me/oauth2/v2.1/token&#x27;</span>;</span><br><span class="line"> <span class="variable">$data</span> = [</span><br><span class="line">     <span class="string">&#x27;grant_type&#x27;</span> =&gt; <span class="string">&#x27;authorization_code&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;code&#x27;</span> =&gt; <span class="variable">$code</span>,</span><br><span class="line">     <span class="string">&#x27;redirect_uri&#x27;</span> =&gt; <span class="variable">$redirect_uri</span>,</span><br><span class="line">     <span class="string">&#x27;client_id&#x27;</span> =&gt; <span class="variable">$client_id</span>,</span><br><span class="line">     <span class="string">&#x27;client_secret&#x27;</span> =&gt; <span class="variable">$client_secret</span></span><br><span class="line"> ];</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 使用 cURL 發送 POST 請求</span></span><br><span class="line"> <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(<span class="variable">$token_url</span>);</span><br><span class="line"> <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_POST, <span class="literal">true</span>);</span><br><span class="line"> <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line"> <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="title function_ invoke__">http_build_query</span>(<span class="variable">$data</span>));</span><br><span class="line"> <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(</span><br><span class="line">     <span class="string">&#x27;Content-Type: application/x-www-form-urlencoded&#x27;</span></span><br><span class="line"> ));</span><br><span class="line"></span><br><span class="line"> <span class="variable">$result</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (<span class="title function_ invoke__">curl_errno</span>(<span class="variable">$ch</span>)) &#123;</span><br><span class="line">     <span class="comment">// 如果 cURL 發生錯誤</span></span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;cURL 錯誤: &quot;</span> . <span class="title function_ invoke__">curl_error</span>(<span class="variable">$ch</span>);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="variable">$response</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$result</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 除錯資訊</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$response</span>[<span class="string">&#x27;access_token&#x27;</span>])) &#123;</span><br><span class="line">         <span class="variable">$access_token</span> = <span class="variable">$response</span>[<span class="string">&#x27;access_token&#x27;</span>];</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 使用存取權杖取得使用者資料</span></span><br><span class="line">         <span class="variable">$profile_url</span> = <span class="string">&#x27;https://api.line.me/v2/profile&#x27;</span>;</span><br><span class="line">         <span class="variable">$ch_profile</span> = <span class="title function_ invoke__">curl_init</span>(<span class="variable">$profile_url</span>);</span><br><span class="line">         <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch_profile</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">         <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch_profile</span>, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(</span><br><span class="line">             <span class="string">&#x27;Authorization: Bearer &#x27;</span> . <span class="variable">$access_token</span></span><br><span class="line">         ));</span><br><span class="line"></span><br><span class="line">         <span class="variable">$result_profile</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch_profile</span>);</span><br><span class="line">         <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch_profile</span>);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (<span class="title function_ invoke__">curl_errno</span>(<span class="variable">$ch_profile</span>)) &#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="string">&quot;cURL 錯誤: &quot;</span> . <span class="title function_ invoke__">curl_error</span>(<span class="variable">$ch_profile</span>);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="variable">$profile</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$result_profile</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$profile</span>[<span class="string">&#x27;userId&#x27;</span>])) &#123;</span><br><span class="line">                 <span class="variable">$line_id</span> = <span class="variable">$profile</span>[<span class="string">&#x27;userId&#x27;</span>];</span><br><span class="line">                 <span class="keyword">echo</span> <span class="string">&quot;使用者的 LINE ID: &quot;</span> . <span class="variable">$line_id</span>;</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// 轉址至指定的 URL</span></span><br><span class="line">                 <span class="variable">$redirect_url</span> = <span class="string">&quot;http://XXX/MessagingAPI/MessagingGetLineID.aspx?py=<span class="subst">&#123;$employee_code&#125;</span>&amp;lineid=<span class="subst">&#123;$line_id&#125;</span>&quot;</span>;</span><br><span class="line">                 <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$redirect_url</span>&quot;</span>);</span><br><span class="line">                 <span class="comment">//因為PHP不熟，我將資訊轉址，至內網(C#)下方便後續，如果PHP有一定的能力可以直接寫入需要的資訊即可。</span></span><br><span class="line">                 <span class="keyword">exit</span>();</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">echo</span> <span class="string">&quot;無法取得使用者的 LINE ID&quot;</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 如果無法取得存取權杖</span></span><br><span class="line">         <span class="keyword">echo</span> <span class="string">&quot;無法取得存取權杖，伺服器回應: &quot;</span> . <span class="variable">$result</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&quot;無法取得授權碼或 state 參數&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Webhook取得GroupId<br> <a target="_blank" rel="noopener" href="https://developers.line.biz/en/docs/messaging-api/receiving-messages/#webhook-event-in-one-on-one-talk-or-group-chat">官方說明文件</a><br> 基本上參考官方說明，event types N多種，詳細要不要啃怎麼啃就看個人啦!這裡我只有一個目地<br> 就是我要知道某群組的GroupId用來傳訊息過去<br> ※因為我的用量不是時時刻刻都在加入群，所以這裡我只有取得GroupId+取得時間!<br> EX：A時段加入是”某A群”，我後續會手工註記<br> 所以如果你的用量比較大，可能需要想想如何關聯群組(名)和GroupId。<br> 以下小抄一樣是PHP，使用accessToken去通關events，將GroupId先寫在一個Log中<br> 然後轉址至內網做後續db寫入。  </p>
</li>
<li><p>Webhook頁面(PHP)</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 設定 LINE Messaging API 的 Channel Access Token</span></span><br><span class="line"><span class="variable">$accessToken</span> = <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"><span class="comment">// 取得 POST 的原始資料</span></span><br><span class="line"><span class="variable">$input</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="variable">$events</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$input</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 檢查事件是否存在</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_null</span>(<span class="variable">$events</span>[<span class="string">&#x27;events&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$events</span>[<span class="string">&#x27;events&#x27;</span>] <span class="keyword">as</span> <span class="variable">$event</span>) &#123;</span><br><span class="line">        <span class="comment">// 當被加入群組時</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$event</span>[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;join&#x27;</span> &amp;&amp; <span class="variable">$event</span>[<span class="string">&#x27;source&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$groupId</span> = <span class="variable">$event</span>[<span class="string">&#x27;source&#x27;</span>][<span class="string">&#x27;groupId&#x27;</span>];</span><br><span class="line">            <span class="variable">$dateTime</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>);</span><br><span class="line">            <span class="comment">// 檢查 GroupId 是否已經存在於 debug.log</span></span><br><span class="line">            <span class="variable">$logContent</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;debug.log&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$logContent</span>, <span class="variable">$groupId</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="comment">// 將 GroupId 和日期時間寫入 debug.log</span></span><br><span class="line">                <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;debug.log&#x27;</span>, <span class="string">&quot;[<span class="subst">$dateTime</span>] GroupId: <span class="subst">$groupId</span>\n&quot;</span>, FILE_APPEND);</span><br><span class="line">                <span class="comment">// 轉址至指定 URL</span></span><br><span class="line">                <span class="variable">$url</span> = <span class="string">&quot;http://xxx/MessagingAPI/MessagingGetGroupID.aspx?GroupId=<span class="subst">$groupId</span>&quot;</span>;</span><br><span class="line">                <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">                <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">                <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">                <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">                <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 回應 200 OK</span></span><br><span class="line"><span class="title function_ invoke__">http_response_code</span>(<span class="number">200</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p> 以上完成後，基本上就….結束了啊!!!笑<br> 好吧 把事情做完!傳送的小抄來一下。╮(╯∀╰)╭  </p>
<p>傳送個人UserId(1對1)或群組GropuId是一組的<br>用的是<a target="_blank" rel="noopener" href="https://api.line.me/v2/bot/message/push">https://api.line.me/v2/bot/message/push</a><br>所以這二個放在一起, UserId和GropuId可替換.   </p>
<ul>
<li>傳送至message&#x2F;push <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">BtnSendMessage_Click</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> userId = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">    <span class="comment">//string groupid = &quot;xxx&quot;; //groupid</span></span><br><span class="line">    <span class="built_in">string</span> channelAccessToken = <span class="string">&quot;xxxxxxxxxx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> message = <span class="string">&quot;測試發送-開發中!;</span></span><br><span class="line"><span class="string">    await SendLineMessage(channelAccessToken, userId, message);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> private async System.Threading.Tasks.Task SendLineMessage(string token, string userId, string message)</span></span><br><span class="line"><span class="string"> &#123;</span></span><br><span class="line"><span class="string">     using (var client = new HttpClient())</span></span><br><span class="line"><span class="string">     &#123;</span></span><br><span class="line"><span class="string">         client.DefaultRequestHeaders.Add(&quot;</span>Authorization<span class="string">&quot;, $&quot;</span>Bearer &#123;token&#125;<span class="string">&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">         var data = new</span></span><br><span class="line"><span class="string">         &#123;</span></span><br><span class="line"><span class="string">             to = userId,</span></span><br><span class="line"><span class="string">             messages = new[]</span></span><br><span class="line"><span class="string">             &#123;</span></span><br><span class="line"><span class="string">             new &#123; type = &quot;</span>text<span class="string">&quot;, text = message &#125;</span></span><br><span class="line"><span class="string">         &#125;</span></span><br><span class="line"><span class="string">         &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">         var json = JsonConvert.SerializeObject(data);</span></span><br><span class="line"><span class="string">         var content = new StringContent(json, Encoding.UTF8, &quot;</span>application/json<span class="string">&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">         var response = await client.PostAsync(&quot;</span>https:<span class="comment">//api.line.me/v2/bot/message/push&quot;, content);</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (response.IsSuccessStatusCode)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="comment">// 處理成功</span></span><br><span class="line">             Response.Write(<span class="string">&quot;訊息發送成功&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             <span class="comment">// 處理錯誤</span></span><br><span class="line">             <span class="keyword">var</span> errorMessage = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br><span class="line">             Response.Write(<span class="string">&quot;發送失敗：&quot;</span> + response.ReasonPhrase + <span class="string">&quot; - &quot;</span> + errorMessage);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>用於Channel的<strong>推送</strong>用的是<br><a target="_blank" rel="noopener" href="https://api.line.me/v2/bot/message/broadcast">https://api.line.me/v2/bot/message/broadcast</a>  </p>
<ul>
<li>傳送至message&#x2F;broadcast  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">btnSendALL_Click</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="built_in">string</span> channelAccessToken = <span class="string">&quot;xxxxx&quot;</span>;</span><br><span class="line">    <span class="built_in">string</span> message = <span class="string">&quot;測試發送-開發中(我是推送訊息)&quot;</span>;</span><br><span class="line">    <span class="keyword">await</span> SendALLLineMessage(channelAccessToken,message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> System.Threading.Tasks.<span class="function">Task <span class="title">SendALLLineMessage</span>(<span class="params"><span class="built_in">string</span> token ,<span class="built_in">string</span> msg</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient())</span><br><span class="line">    &#123;</span><br><span class="line">        client.DefaultRequestHeaders.Add(<span class="string">&quot;Authorization&quot;</span>, <span class="string">$&quot;Bearer <span class="subst">&#123;token&#125;</span>&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> data = <span class="keyword">new</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            messages = <span class="keyword">new</span>[]</span><br><span class="line">           &#123;</span><br><span class="line">            <span class="keyword">new</span> &#123; type = <span class="string">&quot;text&quot;</span>, text = msg &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> json = JsonConvert.SerializeObject(data);</span><br><span class="line">        <span class="keyword">var</span> content = <span class="keyword">new</span> StringContent(json, Encoding.UTF8, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> response = <span class="keyword">await</span> client.PostAsync(<span class="string">&quot;https://api.line.me/v2/bot/message/broadcast&quot;</span>, content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response.IsSuccessStatusCode)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 處理成功</span></span><br><span class="line">            Response.Write(<span class="string">&quot;訊息發送成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 處理錯誤</span></span><br><span class="line">            <span class="keyword">var</span> errorMessage = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br><span class="line">            Response.Write(<span class="string">&quot;發送失敗：&quot;</span> + response.ReasonPhrase + <span class="string">&quot; - &quot;</span> + errorMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://buymeacoffee.com/lovecatwu"><img src="/../images/cat2.png" alt="請我喝一杯吧"></a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E4%BD%9C/" rel="tag">工作</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/11/29/LINE-Notify%E7%B5%90%E6%9D%9F%E6%9C%8D%E5%8B%99-%E8%BD%89%E6%8F%9BSynology-Chat/">LINE Notify結束服務(轉換Synology Chat)</a><a class="next" href="/2024/09/02/%E5%96%AE%E4%B8%80%E7%99%BB%E5%85%A5-NET-Framework-3-5-%E4%B8%B2%E4%B8%80%E4%B8%8B-NET-Framework-4-7/">單一登入(.NET Framework 3.5 串一下.NET Framework 4.7)</a></div><script src="https://utteranc.es/client.js" repo="Cat914006/comments" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://cat914006.github.io"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="關於"><img class="nofancybox" src="/img/mycat.png"/></a><p>Live a good life.</p><a class="info-icon" href="https://www.instagram.com/catwu999/" title="instagram" target="_blank" style="margin-inline:5px"> <i class="fa fa-instagram" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/Cat914006" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E4%BD%9C/">工作</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/%E5%B7%A5%E4%BD%9C/" style="font-size: 15px;">工作</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/11/29/LINE-Notify%E7%B5%90%E6%9D%9F%E6%9C%8D%E5%8B%99-%E8%BD%89%E6%8F%9BSynology-Chat/">LINE Notify結束服務(轉換Synology Chat)</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/10/28/LINE-Notify%E7%B5%90%E6%9D%9F%E6%9C%8D%E5%8B%99-%E8%BD%89%E6%8F%9BMessaging-API/">LINE Notify結束服務(轉換Messaging API)</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/09/02/%E5%96%AE%E4%B8%80%E7%99%BB%E5%85%A5-NET-Framework-3-5-%E4%B8%B2%E4%B8%80%E4%B8%8B-NET-Framework-4-7/">單一登入(.NET Framework 3.5 串一下.NET Framework 4.7)</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/15/%E6%B8%AC%E4%B8%80%E4%B8%8B/">監視器影像(RTSP)崁入自己的網站</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/12/hello-world/">Hello World & I'm Still Here</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">天下本無事 庸人自擾之.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="複製成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>