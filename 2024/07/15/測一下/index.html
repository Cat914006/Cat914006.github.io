<!DOCTYPE html><html lang="zh-TW"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>監視器影像(RTSP)崁入自己的網站 | 我找了你10年</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">監視器影像(RTSP)崁入自己的網站</h1><a id="logo" href="/.">我找了你10年</a><p class="description">I've spent 10 years searching for you</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 歸檔</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">監視器影像(RTSP)崁入自己的網站</h1><div class="post-meta">2024-07-15<span> | </span><span class="category"><a href="/categories/%E5%B7%A5%E4%BD%9C/">工作</a></span></div><div class="post-content"><ul>
<li>緣起</li>
</ul>
<p> 這個需求緣於前二個月玩了的工業看板後續，使用機台物聯資料庫和ERP資料庫所做雙打輸出，玩大畫面的輸出還是感覺滿霸氣的(雖然底子裡還不是就一樣的東西…笑)，在各項數據都穩定後，所提出的追加需求。 <span id="more"></span></p>
<ul>
<li>架構</li>
</ul>
<p> 現在感覺各種架構可以玩出花來，各種插件讓人眼花到不行，這裡就不統整其他大神的作法了，這裡只展現我的方案，必竟大神更好的方案天天在產生(眼神死…)，我的組合如下</p>
<p>  node + ffmpeg + websocket + flv.js</p>
<p>嗯!話是這麼說，但還是簡單的畫個圖簡單的展示一下基本流程，基本上大多的方案都是在這個流程上找出適合自己的方法，看中間那段接收和轉出間怎麼變出花來。如果下圖看起來很陌生(PS：和我第一次聽老大和我說需求時一樣的話~笑)，可以從「rtsp串流協定」當作關鍵字起手式，不論是老派的GOOGLE大神還是新世界的AI大神，不管是那個神，總是要拜的!就拜完再往下走。<br>  <img src="/../images/pasted-0.png" alt="rtsp轉檔輸出圖"></p>
<ul>
<li>前置準備</li>
</ul>
<p> 最重要的當然是安裝node和ffmpeg，就依自己的作業系統把安裝工作安排上，基本上我開發時是在Windows上開發，佈署是在Linux上，結論上來說~安裝都沒什麼太大的問題，都支援的很完整，為什麼開發在windows，卻搞毛的佈在其他作業上?因為我超認真，二種都想學習啊!………..(問就是…錢不夠機器不夠)</p>
<p> 反正最後下指令確認</p>
<p> <code>node -v  </code><br> <code>ffmpeg -v  </code></p>
<p> 要有版本跑出來，才能往下走!! PS:Windwos系統特別注意，環境變數。</p>
<ul>
<li>分享</li>
</ul>
<p>好啦, 那上面那些都不重要，從這邊開始，開始認真…抄作業了??好像還真的是~ 因為我也是抄來的!(抄個二手貨?笑!) 總之CSDN上有很多資訊! 不喜歡這個版本也是可以參考其他。</p>
<p>來個起手式，先把案子的資料夾建起來，初始化一下，然後把元件裝起來<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir rtsp2html</span><br><span class="line">cd rtsp2html</span><br><span class="line">npm init -y</span><br><span class="line">npm install ws express</span><br></pre></td></tr></table></figure><br> 這邊完成後，即可以來寫server，請建立一個server.js的文件，內容參考如下，請依你的實際情況修改，ex 也許你不能用8080 port 或你就是覺得3000port吉利? 因為我的影像，user是沒有要求聲音的，我有特別拿掉，但聲音也許是你的重點? 當然~最重要的還是…給正確的監視器RTSP-URL囉!!</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> const express = require(&#x27;express&#x27;);</span><br><span class="line">const WebSocket = require(&#x27;ws&#x27;);</span><br><span class="line">const &#123; spawn &#125; = require(&#x27;child_process&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line">const server = require(&#x27;http&#x27;).createServer(app);</span><br><span class="line">const wss = new WebSocket.Server(&#123; server &#125;);</span><br><span class="line"></span><br><span class="line">const PORT = 8080; //設定port</span><br><span class="line"></span><br><span class="line">const cameras = &#123;</span><br><span class="line">    cam95: &#x27;rtsp://aabbccdd:123test@192.168.3.30:554/chID=95&amp;streamtype=main&amp;linkType=tcp&#x27;,  // 監視器RTSP-URL </span><br><span class="line">    cam96: &#x27;rtsp://aabbccdd:123test@192.168.3.30:554/chID=96&amp;streamtype=main&amp;linkType=tcp&#x27;,</span><br><span class="line">    cam97: &#x27;rtsp://aabbccdd:123test@192.168.3.30:554/chID=97&amp;streamtype=main&amp;linkType=tcp&#x27;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(express.static(&#x27;public&#x27;)); //static資料夾，為了除錯環境的簡化，就算我後來不在這裡作業，我還是會在這邊測一次。</span><br><span class="line"></span><br><span class="line">wss.on(&#x27;connection&#x27;, (ws, req) =&gt; &#123;</span><br><span class="line">    const urlParams = new URLSearchParams(req.url.slice(1)); // 取代&#x27;/&#x27;</span><br><span class="line">    const cameraId = urlParams.get(&#x27;camera&#x27;);</span><br><span class="line">    const rtspUrl = cameras[cameraId];</span><br><span class="line"></span><br><span class="line">    if (!rtspUrl) &#123;</span><br><span class="line">        ws.close();</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    console.log(`Client connected to $&#123;cameraId&#125;`);</span><br><span class="line"></span><br><span class="line">   const ffmpeg = spawn(&#x27;ffmpeg&#x27;, [</span><br><span class="line">    &#x27;-loglevel&#x27;, &#x27;error&#x27;,</span><br><span class="line">    &#x27;-rtsp_transport&#x27;, &#x27;tcp&#x27;,</span><br><span class="line">    &#x27;-i&#x27;, rtspUrl,</span><br><span class="line">    &#x27;-an&#x27;,  // 去除聲音</span><br><span class="line">    &#x27;-f&#x27;, &#x27;flv&#x27;,</span><br><span class="line">    &#x27;-codec:v&#x27;, &#x27;libx264&#x27;,</span><br><span class="line">    &#x27;-preset&#x27;, &#x27;ultrafast&#x27;,</span><br><span class="line">    &#x27;-tune&#x27;, &#x27;zerolatency&#x27;,</span><br><span class="line">    &#x27;-f&#x27;, &#x27;flv&#x27;,</span><br><span class="line">    &#x27;pipe:1&#x27;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">    ffmpeg.stdout.on(&#x27;data&#x27;, (data) =&gt; &#123;</span><br><span class="line">        ws.send(data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ffmpeg.stderr.on(&#x27;data&#x27;, (data) =&gt; &#123;</span><br><span class="line">        console.error(`FFmpeg error: $&#123;data&#125;`);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ffmpeg.on(&#x27;close&#x27;, (code) =&gt; &#123;</span><br><span class="line">        console.log(`FFmpeg process exited with code $&#123;code&#125;`);</span><br><span class="line">        ws.close();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ws.on(&#x27;close&#x27;, () =&gt; &#123;</span><br><span class="line">        console.log(&#x27;Client disconnected&#x27;);</span><br><span class="line">        ffmpeg.kill(&#x27;SIGINT&#x27;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(PORT, () =&gt; &#123;</span><br><span class="line">    console.log(`Server is listening on port $&#123;PORT&#125;`);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這樣server的部份就上來了!我喜歡就在這個環境下方，先測一下，因為實際環境也許有其他變數，安全性啦、防火、自己搞雷啊等繁多不載!</p>
<p>所以就開始吧! 案子資料夾下建立public資料夾，這個可以依個人的習慣修改，記得server中記得改對應就好!public下建立測試用的html，我這裡就index.html 建起來。</p>
<p>程式中對應2個監視器，我的想法是2個切換的了! 就切換的了千千萬萬個??雖然並不是全然正確!不過我們就這樣開始吧??(說白了就..怎麼感覺懶懶的)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Streaming&lt;/title&gt;</span><br><span class="line">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/flv.js@latest&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;video id=&quot;videoElement&quot; controls autoplay muted style=&quot;width: 65%; height: 80%&quot;&gt;&lt;/video&gt;</span><br><span class="line">    &lt;button onclick=&quot;startStream(&#x27;cam95&#x27;)&quot;&gt;Camera 95&lt;/button&gt;</span><br><span class="line">    &lt;button onclick=&quot;startStream(&#x27;cam96&#x27;)&quot;&gt;Camera 96&lt;/button&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        let flvPlayer;</span><br><span class="line"></span><br><span class="line">        function startStream(cameraId) &#123;</span><br><span class="line">            if (flvPlayer) &#123;</span><br><span class="line">                flvPlayer.unload();</span><br><span class="line">                flvPlayer.detachMediaElement();</span><br><span class="line">                flvPlayer.destroy();</span><br><span class="line">                flvPlayer = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (flvjs.isSupported()) &#123;</span><br><span class="line">                const videoElement = document.getElementById(&#x27;videoElement&#x27;);</span><br><span class="line">                flvPlayer = flvjs.createPlayer(&#123;</span><br><span class="line">                    type: &#x27;flv&#x27;,</span><br><span class="line">                    url: &#x27;ws://&#x27; + location.host + &#x27;/?camera=&#x27; + cameraId</span><br><span class="line">                &#125;);</span><br><span class="line">                flvPlayer.attachMediaElement(videoElement);</span><br><span class="line">                flvPlayer.load();</span><br><span class="line">                flvPlayer.play();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        startStream(&#x27;cam95&#x27;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>沒了~反正我是花時間搞了!誰知道整理起來!這個資料量讓人這麼傷心呢?<br>不過你抄完就直接上了，恭喜你! 以下就整理一下排錯上的思路吧!!</p>
<p>依上面那個醜醜的圖呢!我來簡單整理一下我卡的關卡. </p>
<ol>
<li><p>取得監視器RTSP-URL，這部份好像也不全然是標準規格，不要覺得那一串你猜的出來是放什麼!就直接放了!還是先檢查你的監視器主機，確定該機型有支持RTSP，然後看一下官方網頁，依給他的下去拼!比較不會白走路!11號最貴!(雖然我的薪水好像???)</p>
</li>
<li><p>確認FFmpeg的轉檔，基本上如果上面那一串沒問題的話!可以先用指令轉出一個明確的檔案用來測試，如果他連檔案都轉不出來，那也不用在網路上串來串去的啦!484?? 我後方沒寫路徑，所以看你的cmd下在那裡，他應該會在那個地方產出一個output.flv，這個能播 才有戲唱!</p>
</li>
</ol>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -rtsp_transport tcp -i &quot;url→rtsp://???&quot; -an -c:v libx264 -preset ultrafast -tune zerolatency -f flv output.flv</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>微調參數啦!也許你的情況就是需要聲音，或你的情況就是希望轉出的是265的格式，雖然我看起來，目前265也是很多大神在作，不過我上面這個組合，如果你把參數改成未指定，或指定為265那是吃不了的哦!另有些轉檔也許有雙輸出等(雖然你如果抄作業的話應該不會)，但就怕你和我一樣!喜歡抄半套??對…我就愛亂抄~ 我懂! 總之 如果參數有變動，最後的html使用的套件也要對應起來!</li>
</ol>
<p>那這篇我打算就先寫到這裡，這個需求，使用者還在測試中，如果我後續有想補充，再開新篇吧!改成WebRTC之類的?? 哦 事實上應該不會! (‾◡◝　)</p>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2024/07/12/hello-world/">Hello World &amp; I'm Still Here</a></div><script src="https://utteranc.es/client.js" repo="Cat914006/comments" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://cat914006.github.io"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="關於"><img class="nofancybox" src="/img/mycat.png"/></a><p>Get a life !</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E4%BD%9C/">工作</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/07/15/%E6%B8%AC%E4%B8%80%E4%B8%8B/">監視器影像(RTSP)崁入自己的網站</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/12/hello-world/">Hello World & I'm Still Here</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友站連結</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">我找了你10年.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="複製成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>